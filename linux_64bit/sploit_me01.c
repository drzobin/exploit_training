// Code by Robin Larsson
// rl22ct@student.lnu.se
// robin.larsson@protonmail.ch
// 2019-11-27

// Tested and developed on the following versions.
//
// Ubuntu version:
// root@ubuntu:~# cat /etc/issue
// Ubuntu 18.04.3 LTS \n \l
//
// Kernel version:
// root@ubuntu:~# uname -a
// Linux ubuntu 5.0.0-32-generic #34~18.04.2-Ubuntu SMP Thu Oct 10 10:36:02 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux
//
// Libc version:
// root@ubuntu:~# ldd --version
// ldd (Ubuntu GLIBC 2.27-3ubuntu1) 2.27
//
// GCC version:
// root@ubuntu:~# gcc --version
// gcc (Ubuntu 7.4.0-1ubuntu1~18.04.1) 7.4.0

// Disable PIE/ASLR global.
// echo 0 | sudo tee /proc/sys/kernel/randomize_va_space
//
// Enable PIE/ASLR global.
// echo 2 | sudo tee /proc/sys/kernel/randomize_va_space

// gcc compile options.
//
// DEP/NX
// Enable: by default
// Disable: -zexecstack
//
// Stack Canary
// Enable: -fstack-protector-strong --param=ssp-buffer-size=4
// Disable: -fno-stack-protector
//
// Fortify Source
// Enable: -D_FORTIFY_SOURCE=2
// Disable: by default
//
// PIE
// Enable: -fPIE
// Diable: -fno-PIE
//
// Relocation table binding
// Enable: -Wl,-z,now
// Disable: -Wl,-z,lazy

// gcc compile examples.
//
// Disables stack canaries, disable RELRO and also gives execution permissions to the stack.
// gcc -g  -Wl,-z,norelro -fno-stack-protector -zexecstack -o sploit_me01 sploit_me01.c 
//
// Enable stack canaries, enable full RELRO, enable NX, enable Fortify Source.
// gcc -fstack-protector-strong --param=ssp-buffer-size=4 -fPIE -D_FORTIFY_SOURCE=2 -Wl,-z,now -o sploit_me01 sploit_me01.c
//
// Static compile, Disabled RELRO, disable stack canaries, disable PIE, enable NX.
// gcc -g -static -fno-stack-protector -fno-PIE -D_FORTIFY_SOURCE=2 -o sploit_me01 sploit_me01.c
//
// Dynamic compile, Disabled RELRO, disable stack canaries, disable PIE, enable NX.
// gcc -g -fno-stack-protector -D_FORTIFY_SOURCE=2 -o sploit_me01 sploit_me01.c
//
// Transform to take input from socket.
// socat tcp-listen:9000,reuseaddr,fork, exec:"./sploit_me_v10"

// Compile and setup for exploitation:
// Step 1: Disabel PIE/ASLR global.
// echo 0 | sudo tee /proc/sys/kernel/randomize_va_space
//
// Step 2: Compile the binary.
// gcc -g -fno-stack-protector -D_FORTIFY_SOURCE=2 -o sploit_me01 sploit_me01.c
//
// Step 3: Set setuid as root.
// sudo chown root sploit_me01
// sudo chmod +s sploit_me01

#include<stdio.h>
#include<stdlib.h>
#include<string.h>

void vuln_func(FILE *file_ptr)
{
    // Store data from file here.
    char data[128];

    // Read content of file until newline. This is where we have a stack based buffer overflow.
    fscanf(file_ptr,"%[^\n]", data);
    
    printf("Content that has been saved from file to stack: %s\n", data);
}

int main()
{   
    FILE *file_ptr;
    int run = 1;
    char file[500];

    // Get the filename to read.
    printf("Please provide location off file to read: ");
    fgets(file,sizeof(file),stdin);
    
    // Remove newline from file.
    strtok(file, "\n");

    if ((file_ptr = fopen(file, "r")) == NULL)
    {
        printf("Error! opening file: %s",file);
        exit(1);         
    }

    // This function has a stack based buffer overflow.
    vuln_func(file_ptr);
    
    fclose(file_ptr);

    return 0;
}
